<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民事訴訟書狀生成系統</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // Global Error Handler
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error:", message, "Source:", source, "Line:", lineno);
            alert("System Error: " + message);
            return true; // Prevents the default browser error handler
        };

        // Debug Info Object
        window.debugInfo = {
            logRequests: true,
            logResponses: true,
            version: "wtlee328-debug-2025-04-18-json-populate", // Updated version/date
            user: "wtlee328",
            timestamp: new Date().toISOString() // Use current time
        };
    </script>
    <style>
        /* --- Base Styles (unchanged but included for completeness) --- */
        :root {
            --primary-color: #1a3b68;
            --secondary-color: #f8f9fa;
            --accent-color: #d4a760; /* Gold */
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8; /* Info blue */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 20px auto; /* Added top/bottom margin */
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px 8px 0 0; /* Rounded top corners if container bg is different */
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Slightly softer shadow */
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem; /* Increased padding */
            border-bottom: 2px solid var(--accent-color); /* Accent border */
            font-weight: 600;
        }
        h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
             font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 0.95rem; /* Slightly smaller label */
        }

        .required:after {
            content: " *";
            color: var(--error-color);
        }

        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
            background-color: #fff; /* Ensure white background */
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 167, 96, 0.25); /* Accent focus ring */
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-section {
            background-color: var(--secondary-color);
            padding: 1.5rem; /* Increased padding */
            border-radius: 6px; /* Slightly more rounded */
            margin-bottom: 2rem; /* Increased margin */
            border-left: 5px solid var(--primary-color); /* Thicker border */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem; /* Increased gap */
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        /* --- Button Styles --- */
        button, .btn { /* Add .btn base class */
            border: none;
            padding: 10px 20px; /* Adjusted padding */
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, opacity 0.3s, transform 0.1s; /* Added transform */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle; /* Align buttons better if wrapping */
            line-height: 1.5; /* Ensure consistent height */
            text-decoration: none; /* Remove underline from potential <a> tags styled as buttons */
        }
        button:active, .btn:active {
             transform: scale(0.98); /* Slight press effect */
        }

        button i, .btn i {
            margin-right: 8px;
        }
        button:disabled, .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        /* Specific Button Styles */
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0f2a53; }

        .secondary-btn, .btn-secondary { background-color: #6c757d; color: white; }
        .secondary-btn:hover:not(:disabled), .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }

        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #218838; }

        .btn-danger { background-color: var(--error-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }

        .btn-info { background-color: var(--info-color); color: white; }
        .btn-info:hover:not(:disabled) { background-color: #138496; }

        .btn-accent { background-color: var(--accent-color); color: var(--primary-color); }
        .btn-accent:hover:not(:disabled) { background-color: #c89a50; }
        .btn-accent:disabled { background-color: #e0c8a0; color: #a0a0a0; }

        /* AI Button Specific Size */
        #aiSummarizeBtn {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        #aiSummarizeButtonContainer {
            margin-top: 10px;
            text-align: right;
        }


        /* Button Container Layout */
        .buttons-container {
            display: flex;
            justify-content: space-between;
            margin-top: 2.5rem; /* Increased top margin */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px; /* Gap between button groups/buttons */
        }
        .buttons-container > div:first-child { /* Left button group */
             display: flex;
             flex-wrap: wrap; /* Allow buttons within group to wrap */
             gap: 10px;
        }

        /* Uniform Button Size (Desktop) */
        @media (min-width: 769px) {
            .btn-uniform {
                min-width: 120px; /* Minimum width */
                height: 44px; /* Fixed height */
                padding: 10px 15px !important; /* Consistent padding */
                font-size: 0.95rem !important;
                white-space: nowrap !important; /* Prevent text wrapping */
            }
             .buttons-container {
                align-items: center; /* Vertically align items */
            }
        }
         /* Uniform Button Size (Document Modal) - Ensure they are uniform */
         .document-buttons .btn-uniform,
         .document-buttons button { /* Apply to all buttons in modal footer */
             min-width: 120px;
             height: 40px; /* Slightly smaller in modal */
             padding: 8px 15px !important;
             font-size: 0.9rem !important;
             white-space: nowrap !important;
         }


        /* --- Helper/Error Styles --- */
        .helper-text {
            display: block;
            margin-top: 6px; /* Increased margin */
            font-size: 0.85rem;
            color: #6c757d; /* Softer gray */
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 6px;
            display: none; /* Hidden by default */
            font-weight: 500; /* Slightly bolder error text */
        }

        input.error,
        textarea.error,
        select.error {
            border-color: var(--error-color) !important; /* Ensure override */
            background-color: #fff3f3; /* Very light pink background on error */
        }
         input.error:focus,
         textarea.error:focus,
         select.error:focus {
             box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25); /* Red focus ring */
         }

        /* --- Loading Overlay --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75); /* Slightly darker */
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }
        .loading-overlay p {
             margin-top: 15px;
             font-size: 1.1rem;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color); /* Use accent color for spinner */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Notifications --- */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px; /* Slightly more rounded */
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            display: flex;
            align-items: center;
            z-index: 1001;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; /* Smoother transition */
            transform: translateX(120%); /* Start further off-screen */
            opacity: 0;
            min-width: 250px; /* Ensure minimum width */
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification i {
            margin-right: 12px; /* Increased icon margin */
            font-size: 1.3rem; /* Larger icon */
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--error-color); }
        .notification.warning { background-color: var(--warning-color); color: #333; } /* Darker text on yellow */
        .notification.info { background-color: var(--info-color); }

        /* --- Tooltips --- */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: var(--info-color); /* Use info color for question mark */
            cursor: help;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px; /* Wider tooltip */
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 4px;
            padding: 10px 12px; /* More padding */
            position: absolute;
            z-index: 1;
            bottom: 130%; /* Position higher */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            font-weight: normal;
            font-size: 0.85rem;
            line-height: 1.5; /* Improved readability */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
            pointer-events: none; /* Prevent tooltip from interfering with hover */
        }
         .tooltip .tooltip-text::after { /* Arrow */
             content: "";
             position: absolute;
             top: 100%;
             left: 50%;
             margin-left: -5px;
             border-width: 5px;
             border-style: solid;
             border-color: #333 transparent transparent transparent;
         }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
            color: #6c757d;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color); /* Add separator */
        }
         footer p {
             margin-bottom: 0.5rem;
         }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000; /* High z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.6); /* Slightly less dark backdrop */
            animation: fadeIn 0.3s ease-out; /* Fade in animation */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto; /* More top margin */
            padding: 25px 30px; /* Increased padding */
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            width: 85%; /* Slightly wider */
            max-width: 1100px; /* Increased max-width */
            max-height: 90vh; /* Limit height */
            display: flex; /* Use flex for layout */
            flex-direction: column;
            animation: slideIn 0.3s ease-out; /* Slide in animation */
        }
        @keyframes slideIn {
             from { transform: translateY(-30px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px; /* Increased padding */
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px; /* Increased margin */
        }
         .modal-header h2 { /* Style modal title */
             margin: 0;
             border: none; /* Remove border from h2 inside modal */
             padding: 0;
             font-size: 1.5rem;
         }

        .close {
            color: #aaa;
            font-size: 32px; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            line-height: 1; /* Prevent extra spacing */
        }
        .close:hover,
        .close:focus {
            color: #333; /* Darker on hover */
            text-decoration: none;
        }

        .document-area {
            background-color: #fff; /* White background */
            padding: 25px; /* More padding */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            line-height: 1.8;
            overflow-y: auto; /* Enable scrolling for content */
            flex-grow: 1; /* Allow area to grow */
            margin-bottom: 20px; /* Space before buttons */
            font-size: 1rem; /* Ensure readable font size */
        }

        .document-buttons {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 10px;
            justify-content: flex-end; /* Align buttons right */
            margin-top: auto; /* Push buttons to bottom if content is short */
            padding-top: 15px; /* Space above buttons */
            border-top: 1px solid var(--border-color); /* Separator line */
        }

        /* --- Print Styles --- */
        @media print {
            body { background-color: white; } body * { visibility: hidden; }
            .modal, .modal *, .document-area, .document-area * { visibility: visible; }
            .modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; margin: 0; padding: 0; overflow: visible; background-color: white; box-shadow: none; border: none; animation: none; }
            .modal-content { width: 100%; max-width: 100%; margin: 0; padding: 20px; box-shadow: none; border: none; max-height: none; animation: none; }
            .modal-header, .document-buttons, .close { display: none !important; }
            .document-area { border: none; padding: 0; margin: 0; white-space: pre-wrap !important; overflow: visible; background-color: white; font-size: 12pt; line-height: 1.6; }
            header, footer, .container > .card:not(.modal), .debug-panel, .notification, .loading-overlay { display: none; }
        }

        /* --- Debug Panel --- */
        .debug-panel { position: fixed; bottom: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.85); color: #0f0; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; max-width: 350px; max-height: 250px; overflow: auto; z-index: 9999; display: none; border-radius: 4px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); }
        .debug-panel.active { display: block; } .debug-panel .log-entry { border-bottom: 1px dotted #333; padding: 2px 0; word-break: break-all; } .debug-panel .log-entry:last-child { border-bottom: none; } .debug-panel .log-entry.error { color: #f88; } .debug-panel .log-entry.warning { color: #ff8; } .debug-panel .log-entry.request { color: #8bf; } .debug-panel .log-entry.response { color: #8f8; }

        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .container { padding: 10px; margin-top: 10px; } .card { padding: 1rem; } h2 { font-size: 1.4rem; }
            .form-row { flex-direction: column; gap: 0; } .form-col { width: 100%; margin-bottom: 1.2rem; } .form-col:last-child { margin-bottom: 0; }
            .buttons-container { flex-direction: column; align-items: stretch; gap: 15px; } .buttons-container > div:first-child { flex-direction: column; gap: 10px; }
            .buttons-container button, .buttons-container .btn-uniform { width: 100% !important; min-width: auto !important; margin: 0 !important; }
            .modal-content { width: 95%; margin: 5% auto; padding: 15px 20px; max-height: 85vh; } .document-buttons { justify-content: center; } .document-buttons button { flex-grow: 1; min-width: 100px; }
            #aiSummarizeButtonContainer { text-align: center; } #aiSummarizeBtn { width: auto; display: inline-block; }
        }

    </style>
</head>
<body>
    <header>
        <h1>民事訴訟書狀生成系統</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>案件資料填寫</h2>
            <form id="legalDocForm">
                <!-- Section 1: Basic Info -->
                <div class="form-section">
                    <h3>基本資料</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseType" class="required">訴狀類型</label>
                                <select id="caseType" name="caseType" required>
                                    <option value="" disabled selected>請選擇訴狀類型</option>
                                    <option value="民事起訴狀">民事起訴狀</option>
                                    <option value="民事答辯狀">民事答辯狀</option>
                                    <option value="民事準備狀">民事準備狀</option>
                                    <option value="民事辯論意旨狀">民事辯論意旨狀</option>
                                    <option value="民事上訴狀">民事上訴狀</option>
                                </select>
                                <div class="error-message" id="caseType-error">請選擇訴狀類型</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseNumber">案號 (選填)</label>
                                <input type="text" id="caseNumber" name="caseNumber" placeholder="例：113年度訴字第1234號">
                                <span class="helper-text">若為新案件或未知案號可不填</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="courtName" class="required">法院名稱</label>
                                <select id="courtName" name="courtName" required>
                                    <option value="臺灣臺北地方法院">臺灣臺北地方法院</option>
                                    <option value="臺灣新北地方法院">臺灣新北地方法院</option>
                                    <option value="臺灣士林地方法院">臺灣士林地方法院</option>
                                    <option value="臺灣桃園地方法院">臺灣桃園地方法院</option>
                                    <option value="臺灣新竹地方法院">臺灣新竹地方法院</option>
                                    <option value="臺灣臺中地方法院">臺灣臺中地方法院</option>
                                    <option value="臺灣彰化地方法院">臺灣彰化地方法院</option>
                                    <option value="臺灣臺南地方法院">臺灣臺南地方法院</option>
                                    <option value="臺灣高雄地方法院">臺灣高雄地方法院</option>
                                     <option value="臺灣橋頭地方法院">臺灣橋頭地方法院</option>
                                    <!-- Add more courts as needed -->
                                    <option value="其他法院">其他法院 (請於訴狀內容確認)</option>
                                </select>
                                 <div class="error-message" id="courtName-error">請選擇或確認法院名稱</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="branchName">股別 (選填)</label>
                                <input type="text" id="branchName" name="branchName" placeholder="例：民事庭 甲股">
                                <span class="helper-text">若不確定可不填</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Parties -->
                <div class="form-section">
                    <h3>當事人資料</h3>
                    <div class="form-group">
                        <label for="plaintiff" class="required">原告資料
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請填寫原告完整姓名、身分證字號（或公司統編）、地址。若有多位原告，請換行分隔。法定代理人亦請註明。</span>
                            </span>
                        </label>
                        <textarea id="plaintiff" name="plaintiff" placeholder="例：
原告 林大明
身分證字號：A123456789
住址：臺北市信義區市府路1號" required></textarea>
                        <div class="error-message" id="plaintiff-error">請填寫原告資料</div>
                    </div>

                    <div class="form-group">
                        <label for="plaintiffRepresentative">原告訴訟代理人 (選填)</label>
                        <textarea id="plaintiffRepresentative" name="plaintiffRepresentative" placeholder="例：
訴訟代理人 王大明律師
設址：臺北市中正區重慶南路一段122號"></textarea>
                        <span class="helper-text">若有委任律師請填寫</span>
                    </div>

                    <div class="form-group">
                        <label for="defendant" class="required">被告資料
                             <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請填寫被告完整姓名、身分證字號（或公司統編）、地址。若有多位被告，請換行分隔。</span>
                            </span>
                        </label>
                        <textarea id="defendant" name="defendant" placeholder="例：
被告 王小華
身分證字號：B987654321
住址：新北市板橋區縣民大道二段7號" required></textarea>
                        <div class="error-message" id="defendant-error">請填寫被告資料</div>
                    </div>

                    <div class="form-group">
                        <label for="defendantRepresentative">被告訴訟代理人 (選填)</label>
                        <textarea id="defendantRepresentative" name="defendantRepresentative" placeholder="例：
訴訟代理人 陳小美律師
設址：臺中市西區自由路一段91號"></textarea>
                    </div>
                </div>

                <!-- Section 3: Case Details -->
                <div class="form-section">
                    <h3>案件內容</h3>
                    <!-- Cause of Action -->
                    <div class="form-group">
                        <label for="caseTitle" class="required">案件案由</label>
                        <input type="text" id="caseTitle" name="caseTitle" placeholder="例：請求返還借款、請求給付貨款、確認所有權存在等" required>
                        <div class="error-message" id="caseTitle-error">請填寫案件案由</div>
                    </div>

                    <!-- Case Process (Moved Here) -->
                    <div class="form-group">
                        <label for="caseProcess">案件詳細經過 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">若需 AI 協助統整案情摘要或事實，請在此詳細描述案件的完整過程、時間、地點、人物、對話、事件等細節。點選下方按鈕觸發 AI。</span>
                            </span>
                        </label>
                        <textarea id="caseProcess" name="caseProcess" rows="6" placeholder="請詳細描述案件從發生到現在的完整經過..."></textarea>
                        <!-- AI Button Container -->
                        <div id="aiSummarizeButtonContainer">
                            <!-- AI button will be dynamically added here by JS -->
                        </div>
                         <div class="error-message" id="caseProcess-error"></div> <!-- Error message placeholder for AI -->
                    </div>

                    <!-- Requests / Claims -->
                    <div class="form-group">
                        <label for="requests" class="required">訴之聲明 (請求事項)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您希望法院判決的具體內容，應明確、可執行。例如：被告應給付原告...元、確認...契約無效等。利息計算方式也請寫明。</span>
                            </span>
                        </label>
                        <textarea id="requests" name="requests" rows="5" placeholder="例：
一、被告應給付原告新台幣○○萬元整。
二、及自起訴狀繕本送達翌日起至清償日止，按週年利率百分之五計算之利息。
三、訴訟費用由被告負擔。
（若為起訴，可加：四、原告願供擔保，請准宣告假執行。）" required></textarea>
                        <div class="error-message" id="requests-error">請填寫訴之聲明 (請求事項)</div>
                    </div>

                    <!-- Facts -->
                    <div class="form-group">
                        <label for="facts" class="required">事實及理由
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請依時間順序，分點敘述支持您訴之聲明的客觀事實與法律理由。每點應簡潔明瞭，至少需包含3個關鍵事實點。可引用證據（如：詳參原證1）。</span>
                            </span>
                        </label>
                        <textarea id="facts" name="facts" rows="8" placeholder="例：
一、原告於民國113年○月○日借款新台幣○○萬元予被告，約定清償日為113年○月○日（詳參原證1：借據影本）。
二、詎被告屆期竟未清償，經原告於113年○月○日以存證信函催告（詳參原證2：存證信函影本），被告仍置之不理。
三、依民法第478條規定，被告自應負返還借款之責。..." required></textarea>
                        <div class="error-message" id="facts-error">請填寫事實及理由，至少3點</div>
                    </div>

                    <!-- Evidence -->
                    <div class="form-group">
                        <label for="evidence" class="required">證據名稱及件數
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您提出的所有證據文件名稱及其件數。例如：原證1：借據影本乙份。若為被告，則用「被證」。</span>
                            </span>
                        </label>
                        <textarea id="evidence" name="evidence" rows="4" placeholder="例：
原證1：借據影本乙份
原證2：存證信函暨回執影本乙份
原證3：匯款紀錄截圖乙張
..." required></textarea>
                        <div class="error-message" id="evidence-error">請填寫證據名稱及件數</div>
                    </div>

                    <!-- Applicable Laws -->
                    <div class="form-group">
                        <label for="laws">適用法條 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請列出您認為適用的主要法條，每條一行。</span>
                            </span>
                        </label>
                        <textarea id="laws" name="laws" rows="3" placeholder="例：
民法第474條
民法第478條
民法第229條第1項
民事訴訟法第78條"></textarea>
                         <span class="helper-text">可不填，由 AI 統整或生成訴狀時判斷</span>
                    </div>

                    <!-- Precedents / Rulings -->
                    <div class="form-group">
                        <label for="precedents">相關判決 (選填)</label>
                        <textarea id="precedents" name="precedents" rows="2" placeholder="例：
最高法院○○年度台上字第○○號判決意旨參照"></textarea>
                        <span class="helper-text">若有引用特定判決可填寫</span>
                    </div>
                </div>

                <!-- Section 4: Contact Info -->
                <div class="form-section">
                    <h3>聯絡資訊 (供系統通知使用)</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="email" class="required">電子郵件</label>
                                <input type="email" id="email" name="email" placeholder="請輸入常用有效的電子郵件信箱" required>
                                <div class="error-message" id="email-error">請填寫有效的電子郵件</div>
                                <span class="helper-text">用於接收生成結果通知或文件</span>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="phone">聯絡電話 (選填)</label>
                                <input type="text" id="phone" name="phone" placeholder="例：0912-345678">
                                <span class="helper-text">非必填</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons Container -->
                <div class="buttons-container" id="buttonsContainer">
                    <!-- Buttons will be dynamically added here by JS -->
                </div>
            </form>
        </div> <!-- End Card -->
    </div> <!-- End Container -->

    <!-- Modal for Displaying Generated Document -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成的訴狀預覽</h2>
                <span class="close" title="關閉">×</span>
            </div>
            <div class="document-area" id="documentContent" aria-live="polite">
                <!-- Generated document text will appear here -->
            </div>
            <div class="document-buttons">
                <button id="copyBtn" class="secondary-btn btn-uniform" title="複製訴狀內容至剪貼簿">
                    <i class="fas fa-copy"></i> 複製內容
                </button>
                <button id="printBtn" class="secondary-btn btn-uniform" title="列印訴狀">
                    <i class="fas fa-print"></i> 列印
                </button>
                <button id="downloadBtn" class="secondary-btn btn-uniform" title="下載為 .txt 文字檔">
                    <i class="fas fa-download"></i> 下載 (.txt)
                </button>
                <button id="emailBtn" class="secondary-btn btn-uniform" title="將訴狀內容(模擬)寄送至您填寫的信箱">
                    <i class="fas fa-envelope"></i> 寄送Email
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>正在處理中，請稍候...</p>
        <p id="estimatedTime"></p>
    </div>

    <!-- Notification Area -->
    <div class="notification" id="notification"></div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel"></div>

    <footer>
        <p>© 2025 民事訴訟書狀生成系統 | 本系統及生成內容僅供學術研究與模擬參考</p>
        <p><small><strong>重要提醒：</strong>使用本系統生成的任何文件均不構成法律意見，請務必諮詢專業律師並由其審閱修改後再行使用。</small></p>
        <p><small>Debug Version: wtlee328 (Press Alt+D for debug panel)</small></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element References ---
            const form = document.getElementById('legalDocForm');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const notification = document.getElementById('notification');
            const debugPanel = document.getElementById('debugPanel');
            const modal = document.getElementById('documentModal');
            const closeModalBtn = modal.querySelector('.close');
            const documentContent = document.getElementById('documentContent');
            const copyBtn = document.getElementById('copyBtn');
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const emailBtn = document.getElementById('emailBtn');
            const buttonsContainer = document.getElementById('buttonsContainer');
            const caseProcessTextarea = document.getElementById('caseProcess');
            const aiSummarizeButtonContainer = document.getElementById('aiSummarizeButtonContainer');
            const estimatedTimeP = document.getElementById('estimatedTime');
            const caseTitleInput = document.getElementById('caseTitle');

            // --- Configuration ---
            const generateWebhookUrl = 'https://9b0a-2600-4040-a2cb-5700-1969-dd70-68c7-8d7.ngrok-free.app/webhook/legal-document';
            const aiWebhookUrl = 'https://9b0a-2600-4040-a2cb-5700-1969-dd70-68c7-8d7.ngrok-free.app/webhook/legal-doc-organizer'; // Ensure this is correct PRODUCTION URL
            const LOCAL_STORAGE_KEY = 'wtlee328_lastLegalDocument';
            const DEBUG_MODE = true;

             // --- Logging Utility ---
            function log(message, type = 'info') {
                 const timestamp = new Date().toLocaleTimeString();
                 const logPrefix = `[${type.toUpperCase()}][${timestamp}]`;
                 if (DEBUG_MODE || type === 'error' || type === 'warning') {
                     if (type === 'error') console.error(logPrefix, message);
                     else if (type === 'warning') console.warn(logPrefix, message);
                     else console.log(logPrefix, message);
                 }
                if (debugPanel) {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${type}`;
                    logEntry.textContent = `[${timestamp}] ${message.toString().substring(0, 300)}`;
                    debugPanel.appendChild(logEntry);
                    while (debugPanel.childNodes.length > 100) { debugPanel.removeChild(debugPanel.firstChild); }
                    debugPanel.scrollTop = debugPanel.scrollHeight;
                }
            }

            // --- UI Feedback Functions ---
            function showNotification(message, type = 'info', duration = 5000) { if (!notification) return; notification.textContent = ''; notification.className = `notification ${type}`; const icon = document.createElement('i'); const iconMap = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' }; icon.className = `fas ${iconMap[type] || 'fa-info-circle'}`; notification.appendChild(icon); notification.appendChild(document.createTextNode(` ${message}`)); notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); }, duration); }
            function showLoading(message = "處理中，請稍候...", estimatedSeconds = null) { if (!loadingOverlay) return; loadingOverlay.querySelector('p:first-of-type').textContent = message; estimatedTimeP.textContent = estimatedSeconds ? `預計需時：約 ${estimatedSeconds} 秒` : ''; loadingOverlay.style.display = 'flex'; }
            function hideLoading() { if (loadingOverlay) loadingOverlay.style.display = 'none'; }

            // --- Form Validation & Error Handling ---
            function clearErrors() { form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none'); form.querySelectorAll('.error').forEach(el => el.classList.remove('error')); }
            function showError(fieldId, message) { const field = document.getElementById(fieldId); const errorElement = document.getElementById(`${fieldId}-error`); if (field) field.classList.add('error'); if (errorElement) { errorElement.textContent = message; errorElement.style.display = 'block'; } else { log(`Error element not found for field: ${fieldId}`, 'warning'); } }
            function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
            function validateForm() { let isValid = true; clearErrors(); log('開始表單驗證', 'validation'); const requiredFields = [ { id: 'caseType', message: '請選擇訴狀類型' }, { id: 'courtName', message: '請選擇法院名稱' }, { id: 'plaintiff', message: '請填寫原告資料' }, { id: 'defendant', message: '請填寫被告資料' }, { id: 'caseTitle', message: '請填寫案件案由' }, { id: 'requests', message: '請填寫訴之聲明 (請求事項)' }, { id: 'facts', message: '請填寫事實及理由' }, { id: 'evidence', message: '請填寫證據名稱及件數' }, { id: 'email', message: '請填寫有效的電子郵件' } ]; requiredFields.forEach(field => { const element = document.getElementById(field.id); if (!element || !element.value.trim()) { showError(field.id, field.message); log(`驗證失敗: ${field.id} - ${field.message}`, 'validation'); isValid = false; } }); const factsValue = document.getElementById('facts').value.trim(); if (factsValue && factsValue.split('\n').filter(line => line.trim()).length < 3) { showError('facts', '事實及理由請至少填寫3點'); log(`驗證失敗: facts - 未滿3點`, 'validation'); isValid = false; } const emailValue = document.getElementById('email').value.trim(); if (emailValue && !validateEmail(emailValue)) { showError('email', '請填寫有效的電子郵件格式'); log(`驗證失敗: email - 格式錯誤`, 'validation'); isValid = false; } log(`表單驗證結果: ${isValid ? '通過' : '失敗'}`, 'validation'); if (!isValid) { const firstError = form.querySelector('.error'); if (firstError) { firstError.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstError.focus({ preventScroll: true }); } } return isValid; }

            // --- Data Handling & Processing ---
            function extractActionInput(responseData) { try { if (typeof responseData === 'string') { try { responseData = JSON.parse(responseData); } catch (e) { /* Not JSON, proceed as string */ } } if (typeof responseData === 'object' && responseData !== null) { if (responseData.action === "Final Answer" && responseData.action_input) { log("提取自 action_input", "process"); return responseData.action_input; } if (responseData.output) { log("提取自 output 屬性", "process"); return responseData.output; } if (responseData.text) { log("提取自 text 屬性", "process"); return responseData.text; } } if(typeof responseData === 'string') { log("作為原始字串處理", "process"); return responseData; } log("未找到已知輸出鍵，將物件字串化", "process"); return JSON.stringify(responseData, null, 2); } catch (e) { log(`提取 action_input/output/text 時出錯: ${e.message}`, 'error'); return responseData; } }
            function processLegalDocumentText(data) { if (!data) return ''; let processedText = extractActionInput(data); log(`處理前文本類型: ${typeof processedText}`, 'debug'); if (typeof processedText === 'string') { processedText = processedText .replace(/\\n/g, '\n') .replace(/\\"/g, '"') .replace(/\\t/g, '\t') .replace(/\\\\/g, '\\'); processedText = processedText.replace(/^```(json|text|markdown)?\s*/gm, '').replace(/```\s*$/gm, ''); log("字串處理完成", 'debug'); } else { log("輸入非字串，無法進行字串處理", 'debug'); } return String(processedText || '').trim(); }

            // --- Local Storage ---
            function saveDocumentToLocalStorage(documentText) { try { const dataToSave = { content: documentText, timestamp: new Date().toISOString() }; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave)); log('訴狀已保存到本地存儲', 'storage'); } catch (e) { log(`無法保存到本地存儲: ${e.message}`, 'error'); showNotification('無法保存本次結果至瀏覽器暫存', 'warning'); } }
            function loadDocumentFromLocalStorage() { try { const savedData = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedData) { const parsedData = JSON.parse(savedData); if (parsedData && parsedData.content && parsedData.timestamp) { return parsedData; } } } catch (e) { log(`無法從本地存儲讀取或解析: ${e.message}`, 'error'); localStorage.removeItem(LOCAL_STORAGE_KEY); } return null; }

            // --- Button Creation & Setup ---
            function createButton(id, text, icon, styleClass, clickHandler, isSubmit = false, isUniform = true) { const button = document.createElement('button'); button.id = id; button.type = isSubmit ? 'submit' : 'button'; button.className = `btn ${styleClass}` + (isUniform ? ' btn-uniform' : ''); button.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`; if (clickHandler) { button.addEventListener('click', clickHandler); } return button; }
            function setupButtons() { buttonsContainer.innerHTML = ''; const leftButtonGroup = document.createElement('div'); const demoButton = createButton('demoBtn', '填入示範', 'magic', 'secondary-btn', fillDemoData); const testButton = createButton('testBtn', '本機測試', 'vial', 'btn-success', runTest); const resetButton = createButton('resetBtn', '清除重填', 'undo', 'btn-danger', resetForm); leftButtonGroup.appendChild(demoButton); leftButtonGroup.appendChild(testButton); leftButtonGroup.appendChild(resetButton); const savedData = loadDocumentFromLocalStorage(); if (savedData && savedData.timestamp) { const timestamp = new Date(savedData.timestamp); const now = new Date(); const diffMinutes = Math.floor((now - timestamp) / (1000 * 60)); if (diffMinutes < 60) { const restoreButton = createButton('restoreBtn', '恢復上次', 'history', 'btn-info', () => { if (savedData.content) { const processedText = processLegalDocumentText(savedData.content); documentContent.textContent = processedText; modal.style.display = 'block'; log(`從本地存儲恢復訴狀 (生成於 ${diffMinutes} 分鐘前)`, 'storage'); showNotification('已恢復上次生成的訴狀內容', 'success'); } else { showNotification('找不到上次的內容', 'warning'); } }); leftButtonGroup.appendChild(restoreButton); log(`發現 ${diffMinutes} 分鐘前生成的本地存儲數據`, 'info'); } } const submitButton = createButton('submitBtn', '生成訴狀', 'file-alt', 'btn-primary', null, true); buttonsContainer.appendChild(leftButtonGroup); buttonsContainer.appendChild(submitButton); form.removeEventListener('submit', handleFormSubmit); form.addEventListener('submit', handleFormSubmit); }

             // --- Button Action Handlers ---
            function fillDemoData() { log('正在填入示範數據...', 'ui'); clearErrors(); document.getElementById('caseType').value = '民事起訴狀'; document.getElementById('courtName').value = '臺灣臺北地方法院'; document.getElementById('plaintiff').value = '林大明\n身分證字號：A123456789\n住址：臺北市信義區市府路1號\n電話：0911-111-111'; document.getElementById('defendant').value = '王小華\n身分證字號：B987654321\n住址：新北市板橋區縣民大道二段7號\n電話：0922-222-222'; document.getElementById('caseTitle').value = '請求返還借款'; document.getElementById('caseProcess').value = '被告王小華於民國113年2月1日向原告林大明開口借款新台幣十萬元整，聲稱家中有急用，約定同年5月1日還款。原告基於多年情誼，於113年2月5日以現金交付予被告。然屆至清償期，被告並未還款。原告於6月1日以LINE訊息催討，被告已讀不回。後續多次以電話聯繫，被告均未接聽或掛斷。'; document.getElementById('requests').value = '一、被告應給付原告新台幣拾萬元整。\n二、及自起訴狀繕本送達翌日起至清償日止，按週年利率百分之五計算之利息。\n三、訴訟費用由被告負擔。\n四、原告願供擔保，請准宣告假執行。'; document.getElementById('facts').value = '一、被告王小華於民國113年2月1日因故向原告林大明借款新台幣（下同）拾萬元，約定清償日為同年5月1日，此有雙方LINE對話紀錄可證（詳參原證1）。\n二、原告遂於113年2月5日將現金拾萬元交付予被告收訖。\n三、詎料清償期屆至後，被告竟未依約返還借款，經原告於同年6月1日以通訊軟體催告（詳參原證1），被告均相應不理，顯已違約。\n四、爰依民法第478條等相關規定提起本訴，請求判如訴之聲明。'; document.getElementById('evidence').value = '原證1：LINE對話紀錄截圖乙份\n原證2：原告113年2月提款紀錄（佐證資金來源）'; document.getElementById('laws').value = '民法第474條\n民法第478條\n民法第229條第1項\n民法第233條第1項'; document.getElementById('precedents').value = ''; document.getElementById('email').value = 'demo.user@example.com'; document.getElementById('phone').value = '0912-345678'; updateAiButtonState(); showNotification('已填入示範數據', 'success'); }
            function runTest() { fillDemoData(); log('開始本機測試流程...', 'test'); showNotification('使用示範數據進行本機測試...', 'info'); showLoading("模擬本機生成中...", 2); setTimeout(() => { hideLoading(); const testResponse = { output: `\n民事起訴狀（測試範本）\n案　　號： （法院自動編列）\n股　　別： （法院自動編列）\n\n原　　告　林大明\n　　　　　身分證字號：A123456789\n　　　　　住址：臺北市信義區市府路1號\n　　　　　電話：0911-111-111\n\n被　　告　王小華\n　　　　　身分證字號：B987654321\n　　　　　住址：新北市板橋區縣民大道二段7號\n　　　　　電話：0922-222-222\n\n為請求返還借款事件，依法起訴事：\n\n　　訴之聲明\n一、被告應給付原告新台幣拾萬元整。\n二、及自起訴狀繕本送達翌日起至清償日止，按週年利率百分之五計算之利息。\n三、訴訟費用由被告負擔。\n四、原告願供擔保，請准宣告假執行。\n\n　　事實及理由\n一、被告王小華於民國113年2月1日因故向原告林大明借款新台幣（下同）拾萬元，約定清償日為同年5月1日，此有雙方LINE對話紀錄可證（詳參原證1）。\n二、原告遂於113年2月5日將現金拾萬元交付予被告收訖。（原告可提出113年2月提款紀錄佐證資金流動，詳參原證2）\n三、詎料清償期屆至後，被告竟未依約返還借款，經原告於同年6月1日以通訊軟體催告（詳參原證1），被告均相應不理，顯已違約。\n四、爰依民法第478條、第229條第1項、第233條第1項等相關規定提起本訴，狀請 鈞院鑒核，賜判如訴之聲明，以維權益。\n\n　　證據\n原證1：LINE對話紀錄截圖乙份。\n原證2：原告113年2月提款紀錄影本乙份。\n\n謹　狀\n臺灣臺北地方法院民事庭　公鑒\n\n中華民國 ${new Date().getFullYear() - 1911} 年 ${new Date().getMonth() + 1} 月 ${new Date().getDate()} 日\n\n具狀人　林大明 （簽名或蓋章）\n` }; const finalOutput = processLegalDocumentText(testResponse); saveDocumentToLocalStorage(finalOutput); documentContent.textContent = finalOutput; modal.style.display = 'block'; log('本機測試訴狀已生成並顯示', 'test'); showNotification('本機測試訴狀已生成！', 'success'); setupButtons(); }, 1500); }
            function resetForm() { if (confirm('您確定要清除所有已填寫的欄位嗎？')) { log('執行表單重置', 'ui'); form.reset(); clearErrors(); updateAiButtonState(); showNotification('表單欄位已清除', 'info'); } }

            // --- AI Summarize Button Logic ---
            function updateAiButtonState() { if (!caseProcessTextarea || !aiSummarizeButtonContainer) return; const processValue = caseProcessTextarea.value.trim(); aiSummarizeButtonContainer.innerHTML = ''; if (processValue) { const aiButton = createButton( 'aiSummarizeBtn', 'AI 統整', 'wand-magic-sparkles', 'btn-accent', triggerAiSummarize, false, false ); aiSummarizeButtonContainer.appendChild(aiButton); } }

            // --- *** NEW Helper Function to Populate Fields from AI JSON *** ---
            function populateFieldsFromAI(aiData) {
                log("正在使用 AI 數據填充表單欄位", "ui");

                const requestsTextarea = document.getElementById('requests');
                const factsTextarea = document.getElementById('facts');
                const lawsTextarea = document.getElementById('laws');

                // Function to format array into numbered/bulleted list string
                const formatList = (items, prefixType = 'number') => {
                     if (!Array.isArray(items) || items.length === 0) return '';
                     // Try to detect if items already have a common prefix (like "a.", "1.", "一、")
                     let hasPrefix = false;
                     if (items.length > 1) {
                        const prefixRegex = /^[a-z\d一二三四五六七八九十]+[、\.\)]\s*/i;
                        const firstPrefix = items[0].match(prefixRegex);
                        if (firstPrefix) {
                            hasPrefix = items.every(item => String(item).startsWith(firstPrefix[0].substring(0,1))); // Check if all start similarly
                        }
                     }

                     return items.map((item, index) => {
                         let currentItem = String(item).trim(); // Ensure it's a string and trim
                         // Remove existing prefix ONLY if we didn't detect a consistent one above
                         // Or always remove if you prefer full control. Let's try always removing for consistency.
                         currentItem = currentItem.replace(/^[\d一二三四五六七八九十]+[、\.\)]\s*/, "") // Matches "1.", "一、", "1)" etc.
                                            .replace(/^[a-z][\.\)]\s*/i, "") // Matches "a.", "b)" etc.
                                            .replace(/^[-•*]\s*/, "") // Matches "-", "•", "*" bullets
                                            .trim();

                         let prefix = '';
                         if (prefixType === 'number') {
                             const chineseNumerals = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
                             prefix = (index < chineseNumerals.length ? chineseNumerals[index] : (index + 1)) + '、';
                         } else if (prefixType === 'bullet') {
                             prefix = '● '; // Use a more distinct bullet
                         } else { // Default to simple index
                             prefix = `${index + 1}. `;
                         }
                         return prefix + currentItem;
                     }).join('\n');
                 };

                // Populate fields, using the formatList function
                if (requestsTextarea && aiData.claims) {
                    requestsTextarea.value = formatList(aiData.claims, 'number');
                    log(`填充 '請求事項' ${aiData.claims.length} 項`, "ui");
                }
                if (factsTextarea && aiData.facts) {
                     factsTextarea.value = formatList(aiData.facts, 'number');
                     log(`填充 '事實及理由' ${aiData.facts.length} 項`, "ui");
                }
                if (lawsTextarea && aiData.laws) {
                     lawsTextarea.value = formatList(aiData.laws, 'bullet');
                     log(`填充 '適用法條' ${aiData.laws.length} 項`, "ui");
                }

                // Optional: Clear the '案件詳細經過' field after successful processing
                // if (caseProcessTextarea) {
                //     caseProcessTextarea.value = '';
                //     updateAiButtonState(); // Hide the AI button again
                // }
            }


            // --- *** triggerAiSummarize Function (Handles sending Title+Process & receiving JSON) *** ---
            async function triggerAiSummarize() {
                // 1. Get Case Process text
                const processText = caseProcessTextarea.value.trim();
                if (!processText) {
                    showNotification('請先在「案件詳細經過」欄位填寫內容', 'warning');
                    caseProcessTextarea.focus();
                    return;
                }

                // 2. Get Case Title text
                const caseTitleText = caseTitleInput ? caseTitleInput.value.trim() : '';
                if (!caseTitleText) {
                    showNotification('請先填寫「案件案由」欄位', 'warning');
                    showError('caseTitle', 'AI 統整需要案件案由');
                    caseTitleInput?.focus();
                    return;
                }
                clearErrors(); // Clear errors if both fields are filled


                // 3. Check Webhook URL validity
                if (!aiWebhookUrl || aiWebhookUrl === 'YOUR_N8N_AI_WEBHOOK_URL_HERE') {
                    showNotification('AI 統整功能未設定或設定錯誤', 'error');
                    log('AI 統整失敗：Webhook URL 未設定或無效', 'error');
                    showError('caseProcess', 'AI 功能設定錯誤');
                    return;
                }

                // 4. Handle Button State
                const aiButton = document.getElementById('aiSummarizeBtn');
                let originalButtonHTML = '';
                 if (aiButton) {
                     originalButtonHTML = aiButton.innerHTML;
                     aiButton.disabled = true;
                     aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 統整中...';
                 }

                log('觸發 AI 統整，發送案件經過和案由到 n8n...', 'request');
                showNotification('正在請求 AI 統整，請稍候...', 'info');

                try {
                    // 5. Create Payload with both fields
                    const payload = {
                        caseTitle: caseTitleText,
                        caseProcess: processText
                    };
                    log('發送到 AI Webhook 的 Payload:', 'debug');
                    if(DEBUG_MODE) console.log("AI Payload:", JSON.stringify(payload, null, 2));

                    // 6. Make Fetch Request
                    const response = await fetch(aiWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': window.debugInfo.user || 'unknown',
                            'X-Action': 'summarize-case-process-with-title'
                        },
                        body: JSON.stringify(payload)
                    });

                    log(`AI 統整回應狀態: ${response.status}`, 'response');

                    // 7. Handle Response
                    if (!response.ok) {
                        let errorBody = await response.text();
                        log(`AI 伺服器錯誤回應內容: ${errorBody}`, 'error');
                        let errorMessage = `AI 統整伺服器錯誤: ${response.status} ${response.statusText}.`;
                        try { const errorJson = JSON.parse(errorBody); errorMessage += ` ${errorJson.message || ''}`; }
                        catch (e) { errorMessage += ` ${errorBody.substring(0, 100)}${errorBody.length > 100 ? '...' : ''}`; }
                        throw new Error(errorMessage);
                    }

                    // --- MODIFIED: Expect and handle structured JSON ---
                    const result = await response.json(); // Expecting the structured JSON
                    log('收到 AI 統整結果 (結構化 JSON)', 'response');
                    if (DEBUG_MODE) console.log('AI Result:', JSON.stringify(result, null, 2));

                    // Check for parsing errors reported by the n8n validation node (if implemented)
                    if (result && result.parseError) {
                         showNotification(`AI 回應解析錯誤: ${result.parseError}`, 'error', 8000);
                         log(`n8n 報告解析錯誤: ${result.parseError}`, 'error');
                         if(result.rawOutput) { console.error("LLM Raw Output (解析失敗):", result.rawOutput); }
                    } else if (result && result.warning) { // Check for validation warnings
                         showNotification(`AI 回應結構可能不完整: ${result.warning}`, 'warning', 7000);
                         log(`n8n 報告結構警告: ${result.warning}`, 'warning');
                         populateFieldsFromAI(result); // Attempt to populate anyway
                    } else if (result && result.claims && result.facts && result.laws) {
                        // Populate fields if we received the expected structure
                        populateFieldsFromAI(result); // Call the new helper function
                        showNotification('AI 分析完成，已填入相關欄位！', 'success');
                    } else {
                         // Handle cases where the response is valid JSON but lacks expected keys
                         showNotification('AI 回應成功，但缺少預期的 claims/facts/laws 數據', 'warning');
                         log('AI 成功回應，但缺少預期鍵值', 'warning');
                    }
                    // --- END MODIFIED RESPONSE HANDLING ---

                } catch (error) {
                    // 9. Handle Errors
                    console.error('AI Summarize Fetch Error:', error);
                    log(`AI 統整請求失敗: ${error.message}`, 'error');
                    showNotification(`AI 統整失敗：${error.message || '未知網路或伺服器錯誤'}`, 'error', 8000);
                    showError('caseProcess', `AI 統整失敗`);
                } finally {
                    // 10. Restore Button State
                     if (aiButton) {
                         aiButton.disabled = false;
                         aiButton.innerHTML = originalButtonHTML;
                     }
                }
            } // --- END of triggerAiSummarize Function ---


            // --- Main Form Submission Handler (Unchanged in logic, just ensure it exists) ---
            function handleFormSubmit(e) {
                e.preventDefault(); log('接收到表單提交請求', 'ui');
                if (!validateForm()) { showNotification('提交失敗，請檢查表單紅色標示的欄位', 'error'); return; }
                const formData = { caseType: document.getElementById('caseType').value, caseNumber: document.getElementById('caseNumber').value || null, courtInfo: { name: document.getElementById('courtName').value, branch: document.getElementById('branchName').value || null }, parties: { plaintiff: { info: document.getElementById('plaintiff').value, representative: document.getElementById('plaintiffRepresentative').value || null }, defendant: { info: document.getElementById('defendant').value, representative: document.getElementById('defendantRepresentative').value || null } }, caseDetails: { title: document.getElementById('caseTitle').value, requests: document.getElementById('requests').value.split('\n').filter(line => line.trim()), factsAndReasons: document.getElementById('facts').value, factsAndReasonsList: document.getElementById('facts').value.split('\n').filter(line => line.trim()), caseProcess: document.getElementById('caseProcess').value || null, evidence: document.getElementById('evidence').value.split('\n').filter(line => line.trim()), laws: document.getElementById('laws').value ? document.getElementById('laws').value.split('\n').filter(line => line.trim()) : [], precedents: document.getElementById('precedents').value ? document.getElementById('precedents').value.split('\n').filter(line => line.trim()) : [] }, contact: { email: document.getElementById('email').value, phone: document.getElementById('phone').value || null }, metadata: { submissionTimestamp: new Date().toISOString(), formVersion: window.debugInfo.version || 'unknown', userId: window.debugInfo.user || 'unknown', system: "wtlee328-legal-doc-gen" } };
                log('表單數據已收集完畢', 'data'); if (DEBUG_MODE) console.log("準備發送的數據:", JSON.stringify(formData, null, 2));
                showLoading("正在生成訴狀，請稍候...", 45); let secondsLeft = 45; const timerInterval = setInterval(() => { secondsLeft--; if (secondsLeft > 0) { estimatedTimeP.textContent = `預計剩餘： ${secondsLeft} 秒`; } else { estimatedTimeP.textContent = `仍在處理中，請耐心等候...`; clearInterval(timerInterval); } }, 1000);
                fetch(generateWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Request-ID': `gen-${Date.now()}-${Math.random().toString(16).substring(2, 8)}` }, body: JSON.stringify(formData) })
                .then(async response => { clearInterval(timerInterval); log(`收到 n8n (生成) 回應，狀態: ${response.status}`, 'response'); if (!response.ok) { let errorBody = await response.text(); log(`伺服器錯誤回應內容: ${errorBody}`, 'error'); throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}. ${errorBody || '無詳細錯誤訊息'}`); } return response.text(); })
                .then(text => { log("收到原始生成回應文本", 'debug'); if (DEBUG_MODE) console.log("Raw Response Text:", text); let data; try { data = JSON.parse(text); } catch (e) { log("生成回應不是有效的 JSON，將直接使用收到的文本", 'debug'); data = text; } return data; })
                .then(data => { hideLoading(); log("收到最終生成回應數據", 'response'); if (DEBUG_MODE) console.log("Processed Response Data:", data); const finalOutput = processLegalDocumentText(data); log("最終訴狀文本已處理完成", 'process'); if (DEBUG_MODE) console.log("Final Output for Display:", finalOutput); saveDocumentToLocalStorage(finalOutput); documentContent.textContent = finalOutput || "未能生成內容，請檢查回應。"; modal.style.display = 'block'; showNotification('訴狀已成功生成！', 'success'); setupButtons(); })
                .catch(error => { clearInterval(timerInterval); hideLoading(); console.error('Form Submission/Generation Error:', error); log(`生成請求失敗: ${error.message}`, 'error'); showNotification(`生成訴狀時發生錯誤：${error.message || '未知錯誤'}`, 'error', 8000); });
            }

            // --- Modal and Document Actions ---
            if (closeModalBtn) { closeModalBtn.addEventListener('click', () => modal.style.display = 'none'); }
            window.addEventListener('click', (event) => { if (event.target === modal) { modal.style.display = 'none'; } });
            window.addEventListener('keydown', (event) => { if (event.key === 'Escape' && modal.style.display === 'block') { modal.style.display = 'none'; } });
             // Copy Logic
             if (copyBtn) { copyBtn.addEventListener('click', () => { const textToCopy = documentContent.textContent; if (!textToCopy) { showNotification('沒有內容可複製', 'warning'); return; } navigator.clipboard.writeText(textToCopy).then(() => { showNotification('訴狀內容已複製到剪貼簿', 'success'); log('內容已複製', 'action'); }).catch(err => { showNotification('複製失敗，瀏覽器可能不支援或未授權', 'error'); log(`複製失敗: ${err.message}`, 'error'); }); }); }
             // Print Logic
             if (printBtn) { printBtn.addEventListener('click', () => { log('觸發列印', 'action'); modal.classList.add('printing'); window.print(); setTimeout(() => modal.classList.remove('printing'), 500); }); }
             // Download Logic
             if (downloadBtn) { downloadBtn.addEventListener('click', () => { try { const text = documentContent.textContent; if (!text) { showNotification('沒有內容可下載', 'warning'); return; } const caseType = document.getElementById('caseType').value || '訴狀'; const today = new Date().toISOString().slice(0, 10); const filename = `${caseType}_${today}.txt`; const blob = new Blob([text], {type: 'text/plain;charset=utf-8'}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); showNotification(`已下載文件：${filename}`, 'success'); log(`訴狀已下載為 ${filename}`, 'action'); } catch (e) { log(`下載失敗: ${e.message}`, 'error'); showNotification('下載文件時發生錯誤', 'error'); } }); }
             // Email Logic (Simulation)
             if (emailBtn) { emailBtn.addEventListener('click', () => { const userEmail = document.getElementById('email').value; const docText = documentContent.textContent; if (!userEmail || !validateEmail(userEmail)) { showNotification('請先在主表單填寫有效的電子郵件地址', 'warning'); showError('email', '請填寫有效的電子郵件以寄送'); return; } if (!docText) { showNotification('沒有訴狀內容可寄送', 'warning'); return; } log(`準備模擬發送郵件至 ${userEmail}`, 'action'); showNotification(`即將模擬發送訴狀至：${userEmail}`, 'info'); emailBtn.disabled = true; emailBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 寄送中...'; setTimeout(() => { emailBtn.disabled = false; emailBtn.innerHTML = '<i class="fas fa-envelope"></i> 寄送Email'; showNotification(`訴狀已「模擬」發送至您的信箱：${userEmail}`, 'success'); log(`模擬郵件已發送至 ${userEmail}`, 'action'); }, 2500); }); }


            // --- Initialization ---
             log(`系統初始化 - v${window.debugInfo.version}`, 'init');
             setupButtons();
             if (caseProcessTextarea) { caseProcessTextarea.addEventListener('input', updateAiButtonState); updateAiButtonState(); }
             else { log('未找到案件經過欄位 (caseProcess textarea)', 'warning'); }
             document.addEventListener('keydown', (e) => { if (e.altKey && e.key === 'd') { debugPanel.classList.toggle('active'); log(`調試面板 ${debugPanel.classList.contains('active') ? '開啟' : '關閉'}`, 'ui'); e.preventDefault(); } });
             showNotification('按下 Alt+D 可顯示/隱藏調試面板', 'info', 7000);

        }); // End DOMContentLoaded
    </script>
</body>
</html>