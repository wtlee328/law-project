<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民事訴訟書狀生成系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // 全局錯誤處理函數
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局錯誤:", message, "來源:", source, "行:", lineno);
            alert("系統發生錯誤: " + message);
            return true;
        };

        // 調試工具
        window.debugInfo = {
            logRequests: true,
            logResponses: true,
            version: "wtlee328-debug-2025-04-10",
            user: "wtlee328",
            timestamp: "2025-04-10 17:24:38"
        };
    </script>
    <style>
        :root {
            --primary-color: #1a3b68;
            --secondary-color: #f8f9fa;
            --accent-color: #d4a760;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .required:after {
            content: " *";
            color: var(--error-color);
        }

        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 167, 96, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-section {
            background-color: var(--secondary-color);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .form-section h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background-color: #0f2a53;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        button i {
            margin-right: 8px;
        }

        .buttons-container {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .secondary-btn {
            background-color: #6c757d;
        }

        .secondary-btn:hover {
            background-color: #5a6268;
        }

        /* AI Summarize Button Style */
        #aiSummarizeBtn {
            background-color: var(--accent-color);
            color: var(--primary-color); /* Darker text for better contrast on gold */
            padding: 8px 15px; /* Smaller padding */
            font-size: 0.9rem; /* Slightly smaller font */
        }
        #aiSummarizeBtn:hover {
             background-color: #c89a50; /* Darker gold on hover */
        }
         #aiSummarizeBtn:disabled {
            background-color: #e0c8a0; /* Lighter disabled gold */
            color: #a0a0a0;
            cursor: not-allowed;
        }
        #aiSummarizeButtonContainer {
            margin-top: 10px;
            text-align: right; /* Align button to the right */
        }

        .helper-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        input.error,
        textarea.error,
        select.error {
            border-color: var(--error-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            display: none; /* Initially hidden */
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            z-index: 1001;
            transition: transform 0.3s ease;
            transform: translateX(150%);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        .notification.info { /* Added info style */
             background-color: #17a2b8;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: var(--primary-color);
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        /* 模態窗口樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .document-area {
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        .document-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* 列印樣式 */
        @media print {
            body * {
                visibility: hidden;
            }
            .modal, .modal *, .document-area, .document-area * {
                visibility: visible;
            }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
                background-color: white;
                box-shadow: none;
                border: none;
            }
             .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            .modal-header, .document-buttons, .close {
                display: none !important;
            }
            .document-area {
                border: none;
                padding: 0;
                margin: 0;
                white-space: pre-wrap; /* Keep line breaks */
            }
        }

        /* Debug 面板 */
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow: auto;
            z-index: 9999;
            display: none;
        }

        .debug-panel.active {
            display: block;
        }

        /* 響應式樣式 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-col {
                width: 100%;
                margin-bottom: 1rem; /* Add margin between cols in mobile */
            }

            button {
                padding: 10px 20px; /* Adjust padding for smaller screens */
            }

            .buttons-container {
                 /* Stack buttons vertically */
                 align-items: stretch; /* Make buttons full width */
                 gap: 10px;
            }
            .buttons-container > div { /* Target the left group */
                display: flex;
                flex-direction: column; /* Stack demo/test/reset */
                width: 100%; /* Make group full width */
                gap: 10px;
            }
             .buttons-container > button { /* Target the submit button */
                width: 100%; /* Make submit button full width */
            }
            .btn-uniform {
                 width: 100% !important; /* Override uniform width */
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            #aiSummarizeButtonContainer {
                text-align: center; /* Center AI button on mobile */
            }
             #aiSummarizeBtn {
                width: auto; /* Don't force AI button to full width */
            }
        }

        /* 統一按鈕大小 - 針對桌面 */
        @media (min-width: 769px) {
            .btn-uniform {
                min-width: 120px; /* Ensure minimum width */
                height: 44px;
                padding: 10px 15px !important; /* Consistent padding */
                margin: 0 !important; /* Remove potential extra margin */
                font-size: 0.95rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: inline-flex; /* Ensure flex alignment */
                align-items: center;
                justify-content: center;
            }
            .buttons-container {
                justify-content: space-between; /* Default alignment */
                align-items: center; /* Vertically align items */
            }
             .buttons-container > div { /* Left group */
                display: flex;
                gap: 10px;
                flex-wrap: nowrap; /* Prevent wrapping in this group */
            }
            .buttons-container > button#submitBtn { /* Generate button */
                 /* Ensure it doesn't shrink */
                 flex-shrink: 0;
            }
        }

    </style>
</head>
<body>
    <header>
        <h1>民事訴訟書狀生成系統</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>案件資料填寫</h2>
            <form id="legalDocForm">
                <div class="form-section">
                    <h3>基本資料</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseType" class="required">訴狀類型</label>
                                <select id="caseType" name="caseType" required>
                                    <option value="">請選擇訴狀類型</option>
                                    <option value="民事起訴狀">民事起訴狀</option>
                                    <option value="民事答辯狀">民事答辯狀</option>
                                    <option value="民事準備狀">民事準備狀</option>
                                    <option value="民事辯論意旨狀">民事辯論意旨狀</option>
                                    <option value="民事上訴狀">民事上訴狀</option>
                                </select>
                                <div class="error-message" id="caseType-error">請選擇訴狀類型</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseNumber">案號 (選填)</label>
                                <input type="text" id="caseNumber" name="caseNumber" placeholder="例：112年度訴字第1234號">
                                <span class="helper-text">若為新案件可不填</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="courtName">法院名稱</label>
                                <select id="courtName" name="courtName">
                                    <option value="臺灣臺北地方法院">臺灣臺北地方法院</option>
                                    <option value="臺灣新北地方法院">臺灣新北地方法院</option>
                                    <option value="臺灣桃園地方法院">臺灣桃園地方法院</option>
                                    <option value="臺灣臺中地方法院">臺灣臺中地方法院</option>
                                    <option value="臺灣臺南地方法院">臺灣臺南地方法院</option>
                                    <option value="臺灣高雄地方法院">臺灣高雄地方法院</option>
                                    <option value="其他法院">其他法院</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="branchName">股別 (選填)</label>
                                <input type="text" id="branchName" name="branchName" placeholder="例：甲股">
                                <span class="helper-text">若不確定可不填</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>當事人資料</h3>
                    <div class="form-group">
                        <label for="plaintiff" class="required">原告資料
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請填寫完整資料，包含姓名、地址、法定代理人（如有）等。公司請填寫統一編號。</span>
                            </span>
                        </label>
                        <textarea id="plaintiff" name="plaintiff" placeholder="例：張三 住台北市中正區忠孝東路100號" required></textarea>
                        <div class="error-message" id="plaintiff-error">請填寫原告資料</div>
                    </div>

                    <div class="form-group">
                        <label for="plaintiffRepresentative">原告訴訟代理人 (選填)</label>
                        <textarea id="plaintiffRepresentative" name="plaintiffRepresentative" placeholder="例：王律師 設台北市信義區松仁路50號10樓"></textarea>
                        <span class="helper-text">若無委任律師可不填</span>
                    </div>

                    <div class="form-group">
                        <label for="defendant" class="required">被告資料</label>
                        <textarea id="defendant" name="defendant" placeholder="例：李四 住高雄市前鎮區中山二路300號" required></textarea>
                        <div class="error-message" id="defendant-error">請填寫被告資料</div>
                    </div>

                    <div class="form-group">
                        <label for="defendantRepresentative">被告訴訟代理人 (選填)</label>
                        <textarea id="defendantRepresentative" name="defendantRepresentative" placeholder="例：陳律師 設台北市中山區南京東路150號5樓"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>案件內容</h3>
                    <!-- 修改點 2: 標題 -> 案由 -->
                    <div class="form-group">
                        <label for="caseTitle" class="required">案件案由</label>
                        <input type="text" id="caseTitle" name="caseTitle" placeholder="例：請求給付貨款事件" required>
                        <div class="error-message" id="caseTitle-error">請填寫案件案由</div>
                    </div>

                    <!-- 修改點 3: 請求事項移到案件事實前面 -->
                    <div class="form-group">
                        <label for="requests" class="required">請求事項
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您希望法院判決的具體請求內容，每項請求一行。</span>
                            </span>
                        </label>
                        <textarea id="requests" name="requests" rows="4" placeholder="例：
1. 被告應給付原告新台幣30萬元及自起訴狀送達翌日起至清償日止，按年息5%計算之利息
2. 訴訟費用由被告負擔
..." required></textarea>
                        <div class="error-message" id="requests-error">請填寫請求事項</div>
                    </div>

                    <div class="form-group">
                        <label for="facts" class="required">案件事實
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請按時間順序條列案件主要事實，每個事件一行，至少包含5個關鍵事件。</span>
                            </span>
                        </label>
                        <textarea id="facts" name="facts" rows="6" placeholder="例：
1. 原告於112年1月1日與被告簽訂買賣契約
2. 原告於112年1月15日交付貨物
3. 被告於112年2月1日應付款但未支付
..." required></textarea>
                        <div class="error-message" id="facts-error">請填寫案件事實，至少3條</div>
                    </div>

                    <!-- 修改點 1: 新增案件經過欄位 -->
                    <div class="form-group">
                        <label for="caseProcess">案件經過 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">若需 AI 協助統整，請在此詳細描述案件過程。</span>
                            </span>
                        </label>
                        <textarea id="caseProcess" name="caseProcess" rows="5" placeholder="請詳細描述案件從發生到現在的完整經過，包含時間、地點、人物、事件等細節..."></textarea>
                        <!-- AI 按鈕容器 -->
                        <div id="aiSummarizeButtonContainer"></div>
                         <div class="error-message" id="caseProcess-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="evidence" class="required">證據資料
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您提供的證據，例如：原證1、原證2等，每項證據一行。</span>
                            </span>
                        </label>
                        <textarea id="evidence" name="evidence" rows="4" placeholder="例：
原證1：買賣契約書影本1份
原證2：送貨單影本1份
原證3：催款通知書影本1份
..." required></textarea>
                        <div class="error-message" id="evidence-error">請填寫證據資料</div>
                    </div>

                    <div class="form-group">
                        <label for="laws">適用法條 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請列出適用的法條，每條一行。</span>
                            </span>
                        </label>
                        <textarea id="laws" name="laws" rows="3" placeholder="例：
民法第153條（契約之成立）
民法第199條（給付遲延）
..."></textarea>
                    </div>

                    <!-- 修改點 4: 判例 -> 判決 -->
                    <div class="form-group">
                        <label for="precedents">相關判決 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請列出相關判決，每則一行。</span>
                            </span>
                        </label>
                        <textarea id="precedents" name="precedents" rows="2" placeholder="例：
最高法院109年台上字第123號判決
..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>聯絡資訊</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="email" class="required">電子郵件</label>
                                <input type="email" id="email" name="email" placeholder="user@example.com" required>
                                <div class="error-message" id="email-error">請填寫有效的電子郵件</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="phone">聯絡電話 (選填)</label>
                                <input type="text" id="phone" name="phone" placeholder="例：0912345678">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="buttons-container" id="buttonsContainer">
                    <!-- 按鈕將由JavaScript動態添加 -->
                </div>
            </form>
        </div>
    </div>

    <!-- 模態窗口用於顯示生成的訴狀 -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成的訴狀</h2>
                <span class="close">×</span>
            </div>
            <div class="document-area" id="documentContent"></div>
            <div class="document-buttons">
                <button id="copyBtn" class="secondary-btn btn-uniform">
                    <i class="fas fa-copy"></i> 複製內容
                </button>
                <button id="printBtn" class="btn-uniform">
                    <i class="fas fa-print"></i> 列印訴狀
                </button>
                <button id="downloadBtn" class="btn-uniform">
                    <i class="fas fa-download"></i> 下載文件
                </button>
                <button id="emailBtn" class="btn-uniform">
                    <i class="fas fa-envelope"></i> 寄送至信箱
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>正在生成訴狀，請稍候...</p>
        <p id="estimatedTime">預計需時：30-60秒</p>
    </div>

    <div class="notification" id="notification"></div>
    <div class="debug-panel" id="debugPanel"></div>

    <footer>
        <p>© 2025 民事訴訟書狀生成系統 | 本系統模擬律師風格，僅供參考</p>
        <p><small>使用本系統生成的訴狀建議由專業律師審核後使用</small></p>
        <p><small>wtlee328 (2025-04-10 17:24:38)</small></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('legalDocForm');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const notification = document.getElementById('notification');
            const debugPanel = document.getElementById('debugPanel');
            const modal = document.getElementById('documentModal');
            const closeModalBtn = document.querySelector('.close');
            const documentContent = document.getElementById('documentContent');
            const copyBtn = document.getElementById('copyBtn');
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const emailBtn = document.getElementById('emailBtn');
            const buttonsContainer = document.getElementById('buttonsContainer');
            const caseProcessTextarea = document.getElementById('caseProcess'); // 新增
            const aiSummarizeButtonContainer = document.getElementById('aiSummarizeButtonContainer'); // 新增

            // N8N Webhook URLs
            const generateWebhookUrl = 'https://9b0a-2600-4040-a2cb-5700-1969-dd70-68c7-8d7.ngrok-free.app/webhook/legal-document';
            // !! 請將 YOUR_N8N_AI_WEBHOOK_URL_HERE 替換成您的 AI 統整 Webhook URL !!
            const aiWebhookUrl = 'YOUR_N8N_AI_WEBHOOK_URL_HERE';

            // --- Debugging & Utility Functions (保持不變) ---
             function log(message, type = 'info') {
                 if (window.debugInfo.logRequests || (type !== 'request' && type !== 'response') ) {
                    const timestamp = new Date().toLocaleTimeString();
                    console.log(`[${type.toUpperCase()}][${timestamp}] ${message}`);

                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${type}`;
                    logEntry.textContent = `[${timestamp}] ${message}`;
                    debugPanel.appendChild(logEntry);

                    while (debugPanel.childNodes.length > 100) { // Limit logs
                        debugPanel.removeChild(debugPanel.firstChild);
                    }
                    debugPanel.scrollTop = debugPanel.scrollHeight;
                }
             }

            document.addEventListener('keydown', function(e) {
                if (e.altKey && e.key === 'd') {
                    debugPanel.classList.toggle('active');
                    e.preventDefault();
                }
            });

             function saveDocumentToLocalStorage(document) {
                 localStorage.setItem('wtlee328_lastDocument', document);
                 localStorage.setItem('wtlee328_lastDocumentTime', new Date().toISOString());
                 log('訴狀已保存到本地存儲', 'storage');
             }

             function loadDocumentFromLocalStorage() {
                 return {
                     document: localStorage.getItem('wtlee328_lastDocument'),
                     timestamp: localStorage.getItem('wtlee328_lastDocumentTime')
                 };
             }

             closeModalBtn.addEventListener('click', function() { modal.style.display = 'none'; });
             window.addEventListener('click', function(event) {
                 if (event.target === modal) { modal.style.display = 'none'; }
             });

             copyBtn.addEventListener('click', function() {
                 navigator.clipboard.writeText(documentContent.textContent).then(() => {
                     showNotification('訴狀內容已複製', 'success');
                 }, () => {
                     showNotification('複製失敗，請手動複製', 'error');
                 });
             });

             printBtn.addEventListener('click', function() { window.print(); });

             downloadBtn.addEventListener('click', function() {
                 const text = documentContent.textContent;
                 const caseType = document.getElementById('caseType').value || '訴狀';
                 const today = new Date().toISOString().slice(0, 10);
                 const filename = `${caseType}_${today}_wtlee328.txt`;
                 const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = filename;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 showNotification(`已下載文件：${filename}`, 'success');
                 log(`訴狀已下載為 ${filename}`, 'action');
             });

             emailBtn.addEventListener('click', function() {
                 const userEmail = document.getElementById('email').value;
                 if (!userEmail || !validateEmail(userEmail)) {
                     showNotification('請先在表單中填寫有效的電子郵件地址', 'warning');
                     showError('email', '請填寫有效的電子郵件以寄送');
                     return;
                 }
                 showNotification(`即將發送訴狀至：${userEmail}`, 'info');
                 log(`準備發送郵件至 ${userEmail}`, 'action');
                 // Simulate backend email sending
                 setTimeout(() => {
                     showNotification(`訴狀已模擬發送至您的信箱：${userEmail}`, 'success');
                     log(`模擬郵件已發送至 ${userEmail}`, 'action');
                 }, 2000);
             });

            function showNotification(message, type) {
                notification.textContent = ''; // Clear previous content
                notification.className = `notification ${type}`; // Reset classes

                const icon = document.createElement('i');
                if (type === 'success') icon.className = 'fas fa-check-circle';
                else if (type === 'error') icon.className = 'fas fa-exclamation-circle';
                else if (type === 'warning') icon.className = 'fas fa-exclamation-triangle';
                else if (type === 'info') icon.className = 'fas fa-info-circle'; // Added info icon

                notification.appendChild(icon);
                notification.appendChild(document.createTextNode(' ' + message)); // Add space after icon

                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }

            function clearErrors() {
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            }

            function showError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                if (field) field.classList.add('error');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }

             function validateEmail(email) {
                 const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                 return emailRegex.test(email);
             }

            function validateForm() {
                let isValid = true;
                clearErrors();
                const requiredFields = [
                    { id: 'caseType', message: '請選擇訴狀類型' },
                    { id: 'plaintiff', message: '請填寫原告資料' },
                    { id: 'defendant', message: '請填寫被告資料' },
                    { id: 'caseTitle', message: '請填寫案件案由' }, // Updated label
                    { id: 'requests', message: '請填寫請求事項' },
                    { id: 'facts', message: '請填寫案件事實' },
                    { id: 'evidence', message: '請填寫證據資料' },
                    { id: 'email', message: '請填寫電子郵件' }
                ];

                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        showError(field.id, field.message);
                        isValid = false;
                    }
                });

                const factsValue = document.getElementById('facts').value.trim();
                if (factsValue && factsValue.split('\n').filter(line => line.trim()).length < 3) {
                    showError('facts', '請至少填寫3條案件事實');
                    isValid = false;
                }

                const emailValue = document.getElementById('email').value.trim();
                if (emailValue && !validateEmail(emailValue)) {
                    showError('email', '請填寫有效的電子郵件格式');
                    isValid = false;
                }

                return isValid;
            }

            function extractActionInput(responseData) {
                try {
                    if (typeof responseData === 'string') {
                        try {
                            const parsedData = JSON.parse(responseData);
                             // Check top-level first
                             if (parsedData.action === "Final Answer" && parsedData.action_input) {
                                 log("從 JSON 頂層提取 action_input", 'process');
                                 return parsedData.action_input;
                             }
                             // Check if output is a string containing JSON
                             if (parsedData.output && typeof parsedData.output === 'string') {
                                try {
                                    const nestedOutput = JSON.parse(parsedData.output);
                                    if (nestedOutput.action === "Final Answer" && nestedOutput.action_input) {
                                        log("從嵌套 JSON.output 字串提取 action_input", 'process');
                                        return nestedOutput.action_input;
                                    }
                                } catch (nestedError) { /* Ignore if output is not JSON */ }
                            }
                            // Check if output is already an object
                            else if (parsedData.output && typeof parsedData.output === 'object') {
                                 if (parsedData.output.action === "Final Answer" && parsedData.output.action_input) {
                                     log("從嵌套 JSON.output 物件提取 action_input", 'process');
                                     return parsedData.output.action_input;
                                 }
                             }
                             // If no action_input found, return output or original if no output
                             return parsedData.output || responseData;
                        } catch (e) {
                            // Not JSON, return original string
                            return responseData;
                        }
                    } else if (responseData && typeof responseData === 'object') {
                         // Check top-level first
                         if (responseData.action === "Final Answer" && responseData.action_input) {
                             log("從物件頂層提取 action_input", 'process');
                             return responseData.action_input;
                         }
                        // Check if output is a string containing JSON
                        if (responseData.output && typeof responseData.output === 'string') {
                            try {
                                const nestedOutput = JSON.parse(responseData.output);
                                if (nestedOutput.action === "Final Answer" && nestedOutput.action_input) {
                                    log("從物件 output 字串提取 action_input", 'process');
                                    return nestedOutput.action_input;
                                }
                            } catch (nestedError) { /* Ignore if output is not JSON */ }
                        }
                        // Check if output is already an object
                        else if (responseData.output && typeof responseData.output === 'object') {
                             if (responseData.output.action === "Final Answer" && responseData.output.action_input) {
                                 log("從物件 output 物件提取 action_input", 'process');
                                 return responseData.output.action_input;
                             }
                        }
                        // If no action_input found, return output or original object if no output
                        return responseData.output || responseData;
                    }
                    return responseData; // Fallback
                } catch (e) {
                    console.error("提取 action_input 時出錯:", e);
                    log(`提取 action_input 失敗: ${e.message}`, 'error');
                    return responseData;
                }
            }

            function processLegalDocumentText(text) {
                 if (!text) return '';
                 let processedText = extractActionInput(text);
                 log("提取後文本類型: " + typeof processedText, 'debug');

                 if (typeof processedText === 'string') {
                     processedText = processedText
                         .replace(/\\n/g, '\n')
                         .replace(/\\"/g, '"')
                         .replace(/\\t/g, '\t')
                         .replace(/\\\\/g, '\\');
                 } else if (processedText && typeof processedText === 'object') {
                     // Try to get a meaningful string representation
                     processedText = JSON.stringify(processedText, null, 2);
                 }
                 return processedText || ''; // Ensure return is always a string
            }

            // --- 按鈕創建與設置 ---
             function createButton(id, text, icon, color, clickHandler, isSubmit = false, isUniform = true) {
                const button = document.createElement('button');
                button.id = id;
                button.type = isSubmit ? 'submit' : 'button';
                if (isUniform) {
                    button.className = 'btn-uniform'; // Apply uniform style
                }
                button.style.backgroundColor = color;
                // Handle hover color based on background
                const hoverColor = lightenDarkenColor(color, -20); // Darken by 20%
                button.onmouseover = () => { if (!button.disabled) button.style.backgroundColor = hoverColor; };
                button.onmouseout = () => { if (!button.disabled) button.style.backgroundColor = color; };

                button.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
                if (clickHandler) {
                    button.addEventListener('click', clickHandler);
                }
                return button;
            }

            // Helper to darken/lighten colors for hover effect
            function lightenDarkenColor(col, amt) {
                let usePound = false;
                if (col[0] == "#") {
                    col = col.slice(1);
                    usePound = true;
                }
                let num = parseInt(col, 16);
                let r = (num >> 16) + amt;
                if (r > 255) r = 255;
                else if (r < 0) r = 0;
                let b = ((num >> 8) & 0x00FF) + amt;
                if (b > 255) b = 255;
                else if (b < 0) b = 0;
                let g = (num & 0x0000FF) + amt;
                if (g > 255) g = 255;
                else if (g < 0) g = 0;
                return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
            }


             function setupButtons() {
                buttonsContainer.innerHTML = ''; // Clear existing
                const leftButtonGroup = document.createElement('div');

                 const demoButton = createButton('demoBtn', '示範', 'magic', '#6c757d', fillDemoData);
                 const testButton = createButton('testBtn', '測試', 'vial', '#28a745', runTest);
                 const resetButton = createButton('resetBtn', '重置', 'undo', '#dc3545', resetForm); // Red for reset

                 leftButtonGroup.appendChild(demoButton);
                 leftButtonGroup.appendChild(testButton);
                 leftButtonGroup.appendChild(resetButton);

                 const savedData = loadDocumentFromLocalStorage();
                 if (savedData.document && savedData.timestamp) {
                     const timestamp = new Date(savedData.timestamp);
                     const now = new Date();
                     const diffMinutes = Math.floor((now - timestamp) / (1000 * 60));

                     if (diffMinutes < 60) { // Show restore if less than 60 mins old
                        const restoreButton = createButton('restoreBtn', '恢復', 'history', '#17a2b8', () => {
                             const processedText = processLegalDocumentText(savedData.document);
                             documentContent.textContent = processedText;
                             modal.style.display = 'block';
                             log(`從本地存儲恢復訴狀 (生成於 ${diffMinutes} 分鐘前)`, 'storage');
                             showNotification('已成功恢復上次生成的訴狀', 'success');
                         });
                         leftButtonGroup.appendChild(restoreButton); // Add to left group
                         showNotification(`發現 ${diffMinutes} 分鐘前生成的訴狀，可點擊 [恢復]`, 'info');
                     }
                 }


                const submitButton = createButton('submitBtn', '生成訴狀', 'file-alt', '#1a3b68', null, true);

                buttonsContainer.appendChild(leftButtonGroup);
                buttonsContainer.appendChild(submitButton);

                form.removeEventListener('submit', handleFormSubmit); // Prevent multiple listeners
                form.addEventListener('submit', handleFormSubmit);
             }
             // --- 按鈕處理函數 ---
             function fillDemoData() {
                document.getElementById('caseType').value = '民事起訴狀';
                document.getElementById('courtName').value = '臺灣臺北地方法院';
                document.getElementById('plaintiff').value = '林大明\n住址：臺北市信義區忠孝東路五段7號\n身分證字號：A123456789';
                document.getElementById('defendant').value = '王小華\n住址：臺中市西屯區文心路二段128號\n身分證字號：B987654321';
                document.getElementById('caseTitle').value = '請求返還借款'; // Changed example
                document.getElementById('requests').value = '1. 被告應給付原告新台幣拾萬元整。\n2. 及自起訴狀繕本送達翌日起至清償日止，按週年利率百分之五計算之利息。\n3. 訴訟費用由被告負擔。';
                document.getElementById('facts').value = '1. 原告於民國113年3月1日借款新台幣拾萬元予被告。\n2. 雙方約定被告應於113年6月1日清償。\n3. 被告屆期未清償借款。\n4. 原告曾於113年7月1日以通訊軟體催討，被告表示無力償還。\n5. 有通訊軟體對話紀錄可稽。';
                document.getElementById('caseProcess').value = '被告王小華於113年2月向原告林大明表示急需用錢週轉，林大明基於朋友情誼，於113年3月1日透過銀行轉帳方式匯款新台幣10萬元至王小華指定帳戶(帳號: 000-111-222333)。當時雙方口頭約定還款日為113年6月1日。到了6月1日，王小華並未還款。林大明於7月1日透過LINE聯繫王小華，王小華表示最近手頭緊，暫時還不出來。之後林大明多次聯繫，王小華均以各種理由拖延。'; // Add demo process
                document.getElementById('evidence').value = '原證1：匯款紀錄截圖乙張\n原證2：LINE對話紀錄截圖數張';
                document.getElementById('laws').value = '民法第474條 (消費借貸)\n民法第478條 (返還義務)\n民法第229條 (給付遲延)';
                document.getElementById('precedents').value = '';
                document.getElementById('email').value = 'demo@example.com';
                document.getElementById('phone').value = '0988777666';
                clearErrors();
                updateAiButtonState(); // Check if AI button should show
                log('已填入示範數據', 'ui');
                showNotification('已填入示範數據', 'success');
             }

             function runTest() {
                 fillDemoData(); // Use demo data for test
                 log('已填入示範數據，準備測試流程', 'test');
                 showNotification('已填入示範數據，模擬提交中...', 'info');
                 loadingOverlay.style.display = 'flex';
                 document.getElementById('estimatedTime').textContent = `模擬處理中...`;

                 setTimeout(() => {
                     loadingOverlay.style.display = 'none';
                     const testResponse = {
                         "action": "Final Answer",
                         "action_input": `民事起訴狀\n案　　號：\n股　　別：\n\n原　　告　林大明\n　　　　　　住址：臺北市信義區忠孝東路五段7號\n　　　　　　身分證字號：A123456789\n\n被　　告　王小華\n　　　　　　住址：臺中市西屯區文心路二段128號\n　　　　　　身分證字號：B987654321\n\n為請求返還借款事件，依法起訴事：\n\n　　訴之聲明\n一、被告應給付原告新台幣拾萬元整。\n二、及自起訴狀繕本送達翌日起至清償日止，按週年利率百分之五計算之利息。\n三、訴訟費用由被告負擔。\n\n　　事實及理由\n一、原告於民國113年3月1日以銀行轉帳方式（詳原證1）交付被告新台幣（下同）拾萬元，約定清償日為113年6月1日，此有雙方通訊軟體對話紀錄可證（詳原證2），兩造間消費借貸契約依法成立。\n\n二、詎被告屆期竟未依約清償，經原告於113年7月1日以通訊軟體催告（詳原證2），被告仍置之不理，迄今分文未付。依民法第478條規定，借用人應於約定期限返還與借用物種類、品質、數量相同之物，被告顯已違約。\n\n三、爰依上開規定及民法第229條第1項、第233條第1項規定，請求被告如數清償借款本金，並給付法定遲延利息。\n\n四、為此狀請 鈞院鑒核，賜判如訴之聲明，以維權益。\n\n　　證據\n原證1：銀行匯款紀錄截圖乙張。\n原證2：LINE對話紀錄截圖數張。\n\n謹　狀\n臺灣臺北地方法院民事庭　公鑒\n\n中華民國 ${new Date().getFullYear() - 1911} 年 ${new Date().getMonth() + 1} 月 ${new Date().getDate()} 日\n\n具狀人　林大明 (簽名蓋章)\n`
                     };

                     const finalOutput = processLegalDocumentText(testResponse);
                     saveDocumentToLocalStorage(finalOutput);
                     documentContent.textContent = finalOutput;
                     modal.style.display = 'block';
                     log('測試訴狀已生成並顯示', 'test');
                     showNotification('測試訴狀已生成！', 'success');
                 }, 1500); // Simulate processing time
             }

             function resetForm() {
                 if (confirm('確定要重置表單嗎？所有已填寫的內容將會清除。')) {
                     form.reset();
                     clearErrors();
                     updateAiButtonState(); // Hide AI button if process field is cleared
                     log('表單已重置', 'ui');
                     showNotification('表單已重置', 'info');
                 }
             }


            // --- AI 統整按鈕邏輯 (修改點 1) ---
            function updateAiButtonState() {
                const processValue = caseProcessTextarea.value.trim();
                aiSummarizeButtonContainer.innerHTML = ''; // Clear previous button

                if (processValue) {
                    const aiButton = document.createElement('button');
                    aiButton.type = 'button';
                    aiButton.id = 'aiSummarizeBtn';
                    aiButton.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> AI 統整';
                    aiButton.addEventListener('click', triggerAiSummarize);
                    aiSummarizeButtonContainer.appendChild(aiButton);
                }
            }

            async function triggerAiSummarize() {
                const processText = caseProcessTextarea.value.trim();
                if (!processText) {
                    showNotification('請先填寫案件經過內容', 'warning');
                    return;
                }

                if (aiWebhookUrl === 'https://9b0a-2600-4040-a2cb-5700-1969-dd70-68c7-8d7.ngrok-free.app/webhook-test/legal-doc-organizer') {
                     showNotification('AI 統整 Webhook URL 尚未設定', 'error');
                     log('AI 統整失敗：Webhook URL 未設定', 'error');
                     return;
                }

                const aiButton = document.getElementById('aiSummarizeBtn');
                if (aiButton) {
                     aiButton.disabled = true;
                     aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 統整中...';
                }

                log('觸發 AI 統整，發送案件經過到 n8n...', 'request');
                showNotification('正在請求 AI 統整...', 'info');

                try {
                    const response = await fetch(aiWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': 'wtlee328', // Add any relevant headers
                            'X-Action': 'summarize'
                        },
                        body: JSON.stringify({ caseProcess: processText })
                    });

                    log(`AI 統整回應狀態: ${response.status}`, 'response');

                    if (!response.ok) {
                        throw new Error(`AI 統整伺服器錯誤: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json(); // Assuming n8n returns JSON { summary: "..." }
                    log('收到 AI 統整結果', 'response');
                    console.log('AI Result:', result);

                    // **如何處理結果？** 目前僅顯示通知。
                    // 若要填入其他欄位，可在此處操作，例如：
                    // const factsTextarea = document.getElementById('facts');
                    // factsTextarea.value = result.summary || 'AI 統整失敗或無結果';

                    showNotification('AI 統整完成！(結果已記錄於控制台)', 'success'); // Modify notification as needed

                } catch (error) {
                    console.error('AI Summarize Error:', error);
                    log(`AI 統整請求錯誤: ${error.message}`, 'error');
                    showNotification('AI 統整失敗：' + error.message, 'error');
                     showError('caseProcess', 'AI 統整失敗，請稍後再試'); // Show error near the field
                } finally {
                     if (aiButton) {
                         aiButton.disabled = false;
                         aiButton.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> AI 統整'; // Restore button
                     }
                }
            }

            // --- 主表單提交邏輯 ---
            function handleFormSubmit(e) {
                e.preventDefault();
                if (!validateForm()) {
                    showNotification('請檢查表單必填欄位或修正錯誤', 'error');
                    log('表單驗證失敗', 'validation');
                    // Scroll to the first error field
                    const firstError = form.querySelector('.error');
                    if(firstError) {
                       firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                       firstError.focus();
                    }
                    return;
                }

                const formData = {
                    caseType: document.getElementById('caseType').value,
                    caseNumber: document.getElementById('caseNumber').value || null, // Send null if empty
                    courtInfo: {
                      name: document.getElementById('courtName').value,
                      branch: document.getElementById('branchName').value || null // Send null if empty
                    },
                    parties: {
                      plaintiff: {
                        info: document.getElementById('plaintiff').value,
                        representative: document.getElementById('plaintiffRepresentative').value || null
                      },
                      defendant: {
                        info: document.getElementById('defendant').value,
                        representative: document.getElementById('defendantRepresentative').value || null
                      }
                    },
                    case: {
                      title: document.getElementById('caseTitle').value, // Corrected: caseTitle is now "案由"
                      requests: document.getElementById('requests').value.split('\n').filter(line => line.trim()),
                      facts: document.getElementById('facts').value.split('\n').filter(line => line.trim()),
                      process: document.getElementById('caseProcess').value || null, // Include caseProcess
                      evidence: document.getElementById('evidence').value.split('\n').filter(line => line.trim()),
                      laws: document.getElementById('laws').value ? document.getElementById('laws').value.split('\n').filter(line => line.trim()) : [],
                      precedents: document.getElementById('precedents').value ? document.getElementById('precedents').value.split('\n').filter(line => line.trim()) : [] // Corrected: precedents is now "相關判決"
                    },
                    contact: {
                      email: document.getElementById('email').value,
                      phone: document.getElementById('phone').value || null
                    },
                    metadata: {
                      timestamp: new Date().toISOString(), // Use current timestamp
                      system: "wtlee328-legal-doc-system",
                      version: "1.1-ai-feature", // Update version
                      user: "wtlee328",
                      formTimestamp: window.debugInfo.timestamp // Include original form timestamp if needed
                    }
                };

                loadingOverlay.style.display = 'flex';
                log('正在發送表單數據到 n8n (生成)...', 'request');
                console.log("發送數據:", JSON.stringify(formData, null, 2)); // Log sent data

                let secondsLeft = 45;
                document.getElementById('estimatedTime').textContent = `預計需時：約 ${secondsLeft} 秒`;
                const timerInterval = setInterval(() => {
                    secondsLeft--;
                    if (secondsLeft > 0) {
                        document.getElementById('estimatedTime').textContent = `預計剩餘： ${secondsLeft} 秒`;
                    } else {
                         document.getElementById('estimatedTime').textContent = `處理中，請稍候...`;
                        clearInterval(timerInterval); // Stop at zero, show processing message
                    }
                }, 1000);

                fetch(generateWebhookUrl, { // Use the correct URL for generation
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': 'wtlee328',
                        'X-Request-Time': new Date().toISOString()
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    clearInterval(timerInterval);
                    log(`收到 n8n (生成) 回應，狀態: ${response.status}`, 'response');
                    if (!response.ok) {
                         // Try to get error message from body
                         return response.text().then(text => {
                             throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}. 訊息: ${text || '無詳細訊息'}`);
                         });
                    }
                    return response.text(); // Process as text first
                })
                 .then(text => {
                    log("收到原始生成回應文本", 'debug');
                    console.log("原始文本:", text);
                    let data;
                    try {
                        data = JSON.parse(text); // Try parsing as JSON
                    } catch (e) {
                        log("生成回應不是 JSON，直接使用文本", 'debug');
                        data = text; // Use text if not JSON
                    }
                    return data;
                })
                .then(data => {
                    loadingOverlay.style.display = 'none';
                    log("收到已處理的生成回應數據", 'response');
                    console.log("處理後數據:", data);

                    const finalOutput = processLegalDocumentText(data); // Process potential action_input
                    log("最終訴狀文本已處理", 'process');

                    saveDocumentToLocalStorage(finalOutput); // Save the generated document
                    documentContent.textContent = finalOutput;
                    modal.style.display = 'block';
                    showNotification('訴狀已成功生成！', 'success');
                    setupButtons(); // Refresh buttons (e.g., update restore button availability)

                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    clearInterval(timerInterval);
                    console.error('Form Submit Error:', error);
                    log(`生成請求錯誤: ${error.message}`, 'error');
                    showNotification('生成訴狀時發生錯誤：' + error.message, 'error');
                });
            }

            // --- Initial Setup ---
            if (caseProcessTextarea) { // Add listener only if element exists
                 caseProcessTextarea.addEventListener('input', updateAiButtonState);
                 updateAiButtonState(); // Initial check
            } else {
                log('未找到案件經過欄位 (caseProcess)', 'warning');
            }

            setupButtons(); // Initialize main buttons
            log("系統已初始化", 'init');
            showNotification('按下 Alt+D 顯示/隱藏調試面板', 'info', 7000); // Longer duration for initial hint

        });
    </script>
</body>
</html>